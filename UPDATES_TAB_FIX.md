# إصلاح شامل لتبويب التحديثات - Updates Tab Comprehensive Fix

## المشاكل التي تم حلها

### 1. مشكلة الاختفاء والعودة
**المشكلة السابقة:**
- عند النقر "شاهدت"، كانت الإشعارات تختفي تماماً
- بعد دقائق تعود مرة أخرى بسبب إعادة الفحص

**الحل:**
- الإشعارات المقروءة الآن **تبقى** ولكن:
  - مع **تشطيب** (line-through) على النص
  - مع **شفافية 60%**
  - زر "شاهدت" يختفي بعد القراءة
  - زر "حذف" ✕ يظهر لإزالتها يدوياً

### 2. مشكلة التكرار
**المشكلة السابقة:**
- نفس الإشعار يظهر بطاقتين أو أكثر
- عند الفحص الدوري، يتم إنشاء إشعار جديد للميديا نفسها

**الحل:**
```typescript
// في addInteraction() - الآن يفحص هل يوجد إشعار غير مقروء لنفس الميديا
const existingIndex = (d.notifications || []).findIndex(
  (n) => 
    (n.type === "update" || n.type === "news") && 
    (n as any).mediaId === media.id && 
    !n.seen
)

// إذا وُجد، يُحدّث الإشعار الموجود بدلاً من إنشاء واحد جديد
if (existingIndex !== -1) {
  updated[existingIndex] = {
    ...updated[existingIndex],
    message: `New ${media.type === "MANGA" ? "chapters" : "episodes"} available: ${diff} new`,
    timestamp: new Date().toISOString(), // تحديث الوقت
  }
  return { notifications: updated }
}
```

### 3. مشكلة الأولوية
**المشكلة السابقة:**
- جميع الإشعارات تُرتب فقط حسب التاريخ
- لا توجد أولوية للأنيميات/المانجا في قائمتك الحالية

**الحل الجديد - ترتيب ذكي بثلاث أولويات:**
```typescript
.sort((a, b) => {
  // أولوية 1: ما تشاهده/تقرأه حالياً يظهر أولاً
  const aIsTracked = trackedMedia.some((m) => m.id === (a as any).mediaId)
  const bIsTracked = trackedMedia.some((m) => m.id === (b as any).mediaId)
  if (aIsTracked && !bIsTracked) return -1
  if (!aIsTracked && bIsTracked) return 1
  
  // أولوية 2: غير المقروء قبل المقروء
  if (!a.seen && b.seen) return -1
  if (a.seen && !b.seen) return 1
  
  // أولوية 3: الأحدث أولاً
  return new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime()
})
```

## الميزات الجديدة

### 1. زر "حذف المقروءة"
- زر جديد بجانب "تعليم الكل كمقروء"
- يحذف جميع الإشعارات التي تم تعليمها كمقروءة
- مفيد لتنظيف القائمة دون حذف كل شيء

### 2. زر حذف فردي
- كل إشعار له زر ✕ للحذف
- يمكن إزالة إشعارات معينة دون التأثير على الباقي

### 3. عرض مرئي محسّن
- **غير مقروء**: عادي، واضح تماماً، مع زر "شاهدت"
- **مقروء**: شفاف 60%، مشطوب، بدون زر "شاهدت"، مع زر حذف

### 4. الشارة (Badge) الذكية
- الآن تعرض فقط عدد الإشعارات **غير المقروءة**
- لا تشمل الإشعارات المقروءة في العدد

## الملفات المعدلة

### 1. `src/components/notifications/notifications-dialog.tsx`
**التغييرات:**
- ✅ تحديث `UpdateNotificationItem` لدعم حالتي المقروء/غير المقروء
- ✅ إضافة زر الحذف الفردي
- ✅ تحديث منطق `updateEntries` لإظهار الكل مع ترتيب ذكي
- ✅ إضافة زر "حذف المقروءة"
- ✅ تحديث `totalUpdates` لحساب غير المقروءة فقط

### 2. `src/hooks/use-auth.tsx`
**التغييرات:**
- ✅ تحديث `addInteraction()` لمنع التكرار
- ✅ إضافة `deleteUpdateNotification()` للحذف الفردي
- ✅ إضافة `deleteAllSeenUpdates()` لحذف المقروءة
- ✅ تصدير الدوال الجديدة

## كيفية الاستخدام

### السيناريو 1: القراءة العادية
1. افتح تبويب التحديثات
2. انقر "شاهدت" على الإشعار
3. الإشعار يصبح شفافاً ومشطوباً (يبقى موجوداً)
4. عند الفحص التالي، لن يُنشأ إشعار مكرر

### السيناريو 2: التنظيف
1. انقر "تعليم الكل كمقروء" لتعليم جميع الإشعارات
2. انقر "حذف المقروءة" لإزالتها كلها مرة واحدة
3. أو احذف إشعارات محددة بالنقر على ✕

### السيناريو 3: الأولوية
- الأنيميات/المانجا في قائمتك الحالية تظهر **في الأعلى** دائماً
- ثم غير المقروءة
- ثم المقروءة
- كلها مرتبة من الأحدث للأقدم

## الاختبار

تم اختبار السيناريوهات التالية:
- ✅ إشعار جديد → يُنشأ بشكل صحيح
- ✅ نفس الإشعار مرتين → يُحدّث الموجود بدلاً من التكرار  
- ✅ النقر "شاهدت" → يبقى مع تشطيب وشفافية
- ✅ الفحص الدوري → لا يُنشئ مكررات
- ✅ الترتيب → القائمة الحالية أولاً
- ✅ الحذف الفردي → يزيل الإشعار المحدد
- ✅ حذف المقروءة → يزيل كل المقروءة فقط
- ✅ الشارة → تعرض العدد الصحيح (غير المقروءة فقط)

## ملاحظات مهمة

1. **الإشعارات المقروءة تبقى حتى تحذفها يدوياً**
   - هذا يمنع "الاختفاء والعودة"
   - يمكنك مراجعة ما قرأته

2. **لا توجد إشعارات مكررة بعد الآن**
   - كل ميديا لها إشعار واحد فقط غير مقروء
   - عند وجود تحديثات جديدة، يُحدّث الإشعار الموجود

3. **الأولوية ذكية جداً**
   - ما تتابعه حالياً يظهر أولاً
   - يساعدك على عدم تفويت تحديثات مهمة

## التوافق

- ✅ يعمل مع الإشعارات الموجودة
- ✅ لا يؤثر على إشعارات التذكيرات (Reminders)
- ✅ لا يؤثر على السجلات (Logs)
- ✅ متوافق مع التصدير/الاستيراد

## الترجمة

تمت إضافة:
- العربية: "حذف المقروءة"
- English: "Delete Read"

يمكن تحسينها لاحقاً في ملف الترجمة.
